<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Pixel Dark Quest</title>
  <style>
    @font-face {
      font-family: 'PixelFont';
      src: url('https://fonts.cdnfonts.com/s/14597/PressStart2P-Regular.woff') format('woff');
    }

    html, body {
      height: 100%;
      margin: 0;
      font-family: 'PixelFont', monospace;
      overflow: hidden;
    }

    body {
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(#0d0d1a, #1a1a2e);
    }

    .wrap {
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    canvas {
      display: block;
      border-radius: 12px;
      background: linear-gradient(#1e1e2e, #12121c);
      box-shadow: 0 0 25px rgba(0, 255, 200, 0.4);
    }

    .ui {
      position: absolute;
      bottom: 16px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      gap: 14px;
    }

    .btn {
      background: #111;
      color: #0ff;
      padding: 12px 18px;
      border-radius: 10px;
      border: 2px solid #0ff;
      font-family: 'PixelFont', monospace;
      font-size: 12px;
      text-transform: uppercase;
      box-shadow: 0 0 10px rgba(0,255,200,0.4);
      transition: background 0.2s, transform 0.1s;
      cursor: pointer;
    }

    .btn:active {
      background: #0ff;
      color: #000;
      transform: scale(0.92);
    }
  </style>
</head>
<body>
  <div class="wrap">
    <canvas id="game" width="960" height="360"></canvas>
    <div class="ui">
      <button id="left" class="btn">◀️ Left</button>
      <button id="jump" class="btn">⏫ Jump</button>
      <button id="right" class="btn">▶️ Right</button>
    </div>
  </div>

  <script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    const DPR = window.devicePixelRatio || 1;

    const SPRITE_SRC = 'https://i.imgur.com/PJN3g2C.jpeg';
    const FRAME_COUNT = 4;
    const FRAME_DISPLAY_WIDTH = 96;
    const FRAME_DISPLAY_HEIGHT = 96;

    let groundY;
    let player = {
      x: 60,
      y: 0,
      w: FRAME_DISPLAY_WIDTH * 0.6,
      h: FRAME_DISPLAY_HEIGHT * 0.9,
      vy: 0,
      grounded: false,
      speed: 4,
      facing: 1
    };

    const sprite = new Image();
    sprite.src = SPRITE_SRC;

    const STATE = { IDLE: 'idle', RUN: 'run', JUMP: 'jump' };
    let playerState = STATE.IDLE;
    let runFrameToggle = 0;
    let frameTimer = 0;

    let leftPressed = false;
    let rightPressed = false;

    const G = 0.9;
    const JUMP_V = -14;

    function resizeCanvas(){
      const w = window.innerWidth;
      const h = window.innerHeight;
      let newW, newH;
      if (w/h > 16/9){
        newH = h;
        newW = Math.floor(h * 16/9);
      } else {
        newW = w;
        newH = Math.floor(w * 9/16);
      }
      canvas.style.width = newW + 'px';
      canvas.style.height = newH + 'px';
      canvas.width = Math.round(newW * DPR);
      canvas.height = Math.round(newH * DPR);
      ctx.setTransform(DPR,0,0,DPR,0,0);

      groundY = canvas.height/DPR - 80;
      player.y = Math.min(player.y || 0, groundY - player.h);
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();

    function updatePhysics(){
      player.vy += G;
      player.y += player.vy;
      if (player.y + player.h >= groundY){
        player.y = groundY - player.h;
        player.vy = 0;
        player.grounded = true;
      } else {
        player.grounded = false;
      }

      if (leftPressed && !rightPressed){
        player.x -= player.speed;
        player.facing = -1;
      } else if (rightPressed && !leftPressed){
        player.x += player.speed;
        player.facing = 1;
      }

      const maxX = canvas.width/DPR - player.w - 8;
      const minX = 8;
      if (player.x < minX) player.x = minX;
      if (player.x > maxX) player.x = maxX;

      if (!player.grounded){
        playerState = STATE.JUMP;
      } else if (leftPressed || rightPressed){
        playerState = STATE.RUN;
      } else {
        playerState = STATE.IDLE;
      }
    }

    function drawPlayer(){
      if (!sprite.complete) return;

      const sW = sprite.width / FRAME_COUNT;
      const sH = sprite.height;
      let srcFrame = 0;
      if (playerState === STATE.IDLE) srcFrame = 0;
      else if (playerState === STATE.RUN) srcFrame = (runFrameToggle === 0 ? 1 : 2);
      else if (playerState === STATE.JUMP) srcFrame = 3;

      const dw = player.w;
      const dh = player.h;
      const dx = player.x;
      const dy = player.y;

      ctx.save();
      if (player.facing === -1){
        ctx.translate(dx + dw/2, 0);
        ctx.scale(-1,1);
        ctx.translate(-(dx + dw/2), 0);
      }

      ctx.drawImage(
        sprite,
        srcFrame * sW, 0, sW, sH,
        dx, dy, dw, dh
      );

      ctx.restore();

      if (!player.grounded){
        ctx.fillStyle = 'rgba(0,0,0,0.3)';
        ctx.beginPath();
        ctx.ellipse(dx + dw/2, groundY + 5, dw/2.5, 6, 0, 0, Math.PI*2);
        ctx.fill();
      }
    }

    function update(){
      updatePhysics();

      frameTimer += 1;
      if (playerState === STATE.RUN){
        if (frameTimer > 7){
          runFrameToggle = 1 - runFrameToggle;
          frameTimer = 0;
        }
      } else {
        runFrameToggle = 0;
        frameTimer = 0;
      }

      draw();
      requestAnimationFrame(update);
    }

    function draw(){
      ctx.clearRect(0,0,canvas.width,canvas.height);

      const grd = ctx.createLinearGradient(0, 0, 0, groundY);
      grd.addColorStop(0, '#0a0a1a');
      grd.addColorStop(1, '#1e1e2e');
      ctx.fillStyle = grd;
      ctx.fillRect(0,0,canvas.width/DPR, groundY);

      ctx.fillStyle = '#224422';
      ctx.fillRect(0, groundY, canvas.width/DPR, canvas.height/DPR - groundY);

      ctx.strokeStyle = '#00ffcc';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(0, groundY);
      ctx.lineTo(canvas.width/DPR, groundY);
      ctx.stroke();

      ctx.fillStyle = '#0ff';
      ctx.font = '12px PixelFont, monospace';
      ctx.fillText('STATE: ' + playerState.toUpperCase(), 12, 24);

      drawPlayer();
    }

    function jump(){
      if (player.grounded){
        player.vy = JUMP_V;
        player.grounded = false;
      }
    }

    window.addEventListener('keydown', (e) => {
      if (e.code === 'ArrowLeft') leftPressed = true;
      if (e.code === 'ArrowRight') rightPressed = true;
      if (e.code === 'Space' || e.code === 'ArrowUp') { e.preventDefault(); jump(); }
    });
    window.addEventListener('keyup', (e) => {
      if (e.code === 'ArrowLeft') leftPressed = false;
      if (e.code === 'ArrowRight') rightPressed = false;
    });

    document.getElementById('left').addEventListener('pointerdown', ()=> leftPressed = true);
    document.getElementById('left').addEventListener('pointerup',   ()=> leftPressed = false);
    document.getElementById('right').addEventListener('pointerdown', ()=> rightPressed = true);
    document.getElementById('right').addEventListener('pointerup',   ()=> rightPressed = false);
    document.getElementById('jump').addEventListener('click', jump);

    canvas.addEventListener('touchstart', (e) => {
      e.preventDefault();
      if (e.touches && e.touches.length === 1) jump();
    }, {passive:false});

    sprite.onload = () => {
      resizeCanvas();
      requestAnimationFrame(update);
    };
    sprite.onerror = () => {
      console.warn('تصویر اسپرايت پیدا نشد: ', SPRITE_SRC);
      resizeCanvas();
      requestAnimationFrame(update);
    };
  </script>
</body>
</html>
